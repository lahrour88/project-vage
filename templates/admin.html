<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>تحليل المواعيد</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="static/admin.css">
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    {% include 'appbar.html' %}
    <div class="container">
        <h1>المواعيد المقبلة </h1>
        <div class="table-container">
            <table id="appointmentsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>الاسم الكامل</th>
                        <th>البريد</th>
                        <th>الهاتف</th>
                        <th>فئة السيارة</th>
                        <th>نوع الخدمة</th>
                        <th>تاريخ الموعد</th>
                        <th>وقت الموعد</th>
                        <th>العنوان</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in table_data %}
                    <tr>
                        <td>{{ row.id }}</td>
                        <td>{{ row.full_name }}</td>
                        <td>{{ row.email }}</td>
                        <td>{{ row.phone_number }}</td>
                        <td>{{ row.car_category }}</td>
                        <td>{{ row.vage_type }}</td>
                        <td>{{ row.appointment_date }}</td>
                        <td>{{ row.appointment_time }}</td>
                        <td>{{ row.adresse }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h1>تحليل المواعيد التي لم تتعدى  3 اشهر</h1>
        
        <div class="chart-box">
            <h2><i class="fa-solid fa-car-side"></i> نسبة المواعيد حسب فئة السياراة</h2>
            <div id="chart-container"></div>
        </div>

        <div class="chart-box">
            <h2><i class="fa-solid fa-soap"></i> نسب المواعيد حسب نوع الغسيل</h2>
            <div id="chart-container_1"></div>
        </div>
    </div>

    <!-- سكريبت الرسم البياني يبقى كما هو -->
<script>
const chartData = {{ chart_data|tojson }};
const colors = [
    'rgba(52, 152, 219, 0.7)',
    'rgba(155, 89, 182, 0.7)',
    'rgba(241, 196, 15, 0.7)',
    'rgba(46, 204, 113, 0.7)',
    'rgba(120, 120, 120, 0.7)',
    'rgba(144, 214, 230, 0.7)'
];

// -------------------------
// 1. رسم لكل فئة سيارة
// -------------------------
const carGrouped = {};
chartData.forEach(item => {
    const car = item.car_category;
    const date = item.appointment_date;
    if (!carGrouped[car]) carGrouped[car] = {};
    if (!carGrouped[car][date]) carGrouped[car][date] = 0;
    carGrouped[car][date] += 1;
});

const carDates = Array.from(new Set(chartData.map(i => i.appointment_date))).sort();
const carDatasets = Object.keys(carGrouped).map((car, idx) => {
    const data = carDates.map(date => carGrouped[car][date] || 0);
    return {
        label: car,
        data: data,
        borderColor: colors[idx % colors.length].replace('0.7', '1'),
        backgroundColor: colors[idx % colors.length],
        fill: false,
        tension: 0.4
    };
});

const carCanvas = document.createElement('canvas');
document.getElementById('chart-container').appendChild(carCanvas);
new Chart(carCanvas.getContext('2d'), {
    type: 'line',
    data: { labels: carDates, datasets: carDatasets },
    options: {
        responsive: true,
        plugins: {
            title: { display: true, text: '', font: { weight: 'bold' } },
            legend: { position: 'bottom', rtl: true },
            tooltip: {
                callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}` },
                rtl: true
            }
        },
        scales: {
            y: { beginAtZero: true, title: { display: true, text: 'عدد المواعيد اليومي' } },
            x: { title: { display: true, text: 'التاريخ' } }
        },
        interaction: { intersect: false, mode: 'index' }
    }
});

// -------------------------
// 2. رسم لكل نوع غسيل
// -------------------------
const vageGrouped = {};
chartData.forEach(item => {
    const vage = item.vage_type;
    const date = item.appointment_date;
    if (!vageGrouped[vage]) vageGrouped[vage] = {};
    if (!vageGrouped[vage][date]) vageGrouped[vage][date] = 0;
    vageGrouped[vage][date] += 1;
});

const vageDates = Array.from(new Set(chartData.map(i => i.appointment_date))).sort();
const vageDatasets = Object.keys(vageGrouped).map((vage, idx) => {
    const data = vageDates.map(date => vageGrouped[vage][date] || 0);
    return {
        label: vage,
        data: data,
        borderColor: colors[idx % colors.length].replace('0.7', '1'),
        backgroundColor: colors[idx % colors.length],
        fill: false,
        tension: 0.4
    };
});

const vageCanvas = document.createElement('canvas');
document.getElementById('chart-container_1').appendChild(vageCanvas);
new Chart(vageCanvas.getContext('2d'), {
    type: 'line',
    data: { labels: vageDates, datasets: vageDatasets },
    options: {
        responsive: true,
        plugins: {
            title: { display: true, text: '', font: { weight: 'bold' } },
            legend: { position: 'bottom', rtl: true },
            tooltip: {
                callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}` },
                rtl: true
            }
        },
        scales: {
            y: { beginAtZero: true, title: { display: true, text: 'عدد المواعيد اليومي' } },
            x: { title: { display: true, text: 'التاريخ' } }
        },
        interaction: { intersect: false, mode: 'index' }
    }
});

// تحسين عرض الهواتف
if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
    document.querySelector('meta[name="viewport"]').setAttribute('content', 'width=1200, initial-scale=1.0');
}
    </script>
</body>
</html>